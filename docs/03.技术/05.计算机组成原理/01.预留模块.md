---
title: 计算机组成原理
date: 2023-01-16 16:21:34
permalink: /pages/5973a0/
categories:
  - 技术
  - 计算机组成原理
tags:
  -
author:
  name: ZhangQiLong
  link: https://github.com/ZhangQiLong2023
---

# 【图解】TCP 三次握手

“什么是[三次握手](https://so.csdn.net/so/search?spm=a2c6h.12873639.article-detail.15.6784b4c32OYBXz&q=三次握手)，四次挥手？”，该问题作为**计算机网络**学科中常见问题之一，无论是面试还是考研，我们都有必要细细参透其中的奥妙，由于涉及到底层原理，就需要我们具备最基本的概念

## 基础理论

### 传输控制协议

传输控制协议（**T**ransmission **C**ontrol **P**rotocol）是一种面向连接的、可靠的、基于字节流的传输层通信协议，在 OSI 模型中完成传输层指定功能。TCP 使用**校验和函数**检验数据是否出现错误，在数据发送和接收时均需要计算**校验和**。

### TCP 的特点

> - TCP 是面向连接的传输层协议：应用程序在使用 TCP 协议前，必须首先完成 TCP 连接的建立。在数据传输结束后，必须释放先前已建立的 TCP 连接
>
> - 每一条 TCP 连接只能有两个端点：TCP 连接只能是点对点，一对一的
>
> - TCP 提供可靠交付服务：通过 TCP 连接传送的数据，无差错、不丢失、不重复，且按序到达
> - TCP 提供全双工通信：TCP 允许通信双方的应用进程在**任何时候**都可以发送数据，TCP 连接的两端都设有**发送、接收缓存**，用于临时存放双向通信的数据，上层应用进程在时机恰当时会读取缓存中的数据
> - TCP 面向字节流：**流** 是指：流入到进程或从进程流出的**字节序列**

TCP 把应用程序回传的数据看做一连串的**无结构**的字节流，不保证接收方应用程序所收到的数据块和发送方应用程序所发出的数据块具有对应大小的关系

接收方应用程序收到的字节流必须和发送方应用程序发出的字节流完全一致，且接收方的应用程序必须具有识别接收字节流，并将其还原为有意义的应用层数据的能力

![image-20230204233425388](http://www.zhangqilong.cn/img/qlBlog_images/%E6%8A%80%E6%9C%AF/%E8%AE%A1%E7%AE%97%E6%9C%BA408%E7%B3%BB%E5%88%97/%E5%9B%BE%E8%A7%A3TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B/image-20230204233425388.png)

## TCP 连接的建立与释放

### TCP 连接建立过程中为什么需要三次握手

先给出结论

> - 为了实现可靠数据传输， TCP 协议的通信双方， 都必须维护一个序列号， 以标识发送出去的数据包中， 哪些是已经被对方收到的。 三次握手的过程即是通信双方相互告知序列号起始值， 并确认对方已经收到了序列号起始值的必经步骤
> - 如果只是两次握手， 至多只有连接发起方的起始序列号能被确认， 另一方选择的序列号则得不到确认

在谢希仁著《[计算机网络](https://www.zhihu.com/search?q=计算机网络&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra={"sourceType"%3A"answer"%2C"sourceId"%3A63668444})》第四版中讲“三次握手”的目的是“为了防止已失效的连接请求 [报文段](https://www.zhihu.com/search?q=报文段&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra={"sourceType"%3A"answer"%2C"sourceId"%3A63668444}) 突然又传送到了服务端，因而产生错误”。采用三次握手可以避免这种情况发生。找到封存已久的计算机网络，具体内容可以参考下图：

![image-20230205202315224](http://www.zhangqilong.cn/img/qlBlog_images/%E6%8A%80%E6%9C%AF/%E8%AE%A1%E7%AE%97%E6%9C%BA408%E7%B3%BB%E5%88%97/%E5%9B%BE%E8%A7%A3TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B/image-20230205202315224.png)

#### 为什么 TCP 需要握手这个操作

对比一下 UDP 的通信流程和 TCP 的通信流程， 可以发现， 在 UDP 协议中， 是没有握手这个操作的。

![image-20230205194636860](http://www.zhangqilong.cn/img/qlBlog_images/%E6%8A%80%E6%9C%AF/%E8%AE%A1%E7%AE%97%E6%9C%BA408%E7%B3%BB%E5%88%97/%E5%9B%BE%E8%A7%A3TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B/image-20230205194636860.png)

一条重要的结论：**TCP 是可靠通信协议， 而 UDP 是不可靠通信协议**

- TCP 的可靠性含义： 接收方收到的数据是完整， 有序， 无差错的。
- UDP 不可靠性含义： 接收方接收到的数据可能存在部分丢失， 顺序也不一定能保证。

##### TCP ACK 机制

由于`通信过程的不可靠性`，传输的数据不可避免的会出现`丢失、延迟、错误、重复等各种状况`，TCP 协议为解决这些问题设计了一系列机制。这个机制的核心，就是发送方向接收方发送数据后，接收方要向发送方发送 ACK（回执）。如果发送方没接收到正确的 ACK，就会重新发送数据直到接收到 ACK 为止。比如：发送方发送的数据序号是 seq，那么接收方会发送 seq + 1 作为 ACK，这样发送方就知道接下来要发送序号为 seq + 1 的数据给接收方了。

![image-20230205202044083](http://www.zhangqilong.cn/img/qlBlog_images/%E6%8A%80%E6%9C%AF/%E8%AE%A1%E7%AE%97%E6%9C%BA408%E7%B3%BB%E5%88%97/%E5%9B%BE%E8%A7%A3TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B/image-20230205202044083.png)

#### 三次握手

为了实现可靠传输，发送方和接收方始终需要同步( SYNchronize )序号。 需要注意的是， 序号并不是从 0 开始的， 而是由发送方随机选择的初始序列号 ( Initial Sequence Number, ISN )开始 。

**由于 TCP 是一个双向通信协议， 通信双方都有能力发送信息， 并接收响应。 因此， 通信双方都需要随机产生一个初始的序列号， 并且把这个起始值告诉对方。**
![image-20230205204848983](http://www.zhangqilong.cn/img/qlBlog_images/%E6%8A%80%E6%9C%AF/%E8%AE%A1%E7%AE%97%E6%9C%BA408%E7%B3%BB%E5%88%97/%E5%9B%BE%E8%A7%A3TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B/image-20230205204848983.png)

`TCP` 建立连接的过程称为**握手**，握手需要在客户端和服务器之间交换三个 `TCP` 报文段

`TCP` 三次握手的作用就是使客户端和服务端双方都明确自己的责任，**保证双方都具有资源接收和发送的能力**

![image-20230205003134631](http://www.zhangqilong.cn/img/qlBlog_images/%E6%8A%80%E6%9C%AF/%E8%AE%A1%E7%AE%97%E6%9C%BA408%E7%B3%BB%E5%88%97/%E5%9B%BE%E8%A7%A3TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B/image-20230205003134631.png)

**字符释意：：**

- `ACK`：确认报文段。仅当 ACK=1 时确认号字段才有效，TCP 规定，在连接建立后所有传送的报文段必须将 ACK 置为 1。
- `ack`：确认号。占 4 字节，期望收到对方下个报文段的第一个数据字节的序号
- `SYN`：发送连接请求 / 接收报文段。
- `seq`：发送数据的第一个字节的序号。占 4 字节，序号范围[0，2^32-1]，序号增加到 2^32-1 后，下个序号又回到 0。TCP 是面向字节流的，通过 TCP 传送的字节流中的每个字节都按顺序编号，而报头中的序号字段值则指的是本报文段数据的第一个字节的序号。

![image-20230205203416093](http://www.zhangqilong.cn/img/qlBlog_images/%E6%8A%80%E6%9C%AF/%E8%AE%A1%E7%AE%97%E6%9C%BA408%E7%B3%BB%E5%88%97/%E5%9B%BE%E8%A7%A3TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B/image-20230205203416093.png)

如上图所说， 最后一次握手在默认不携带数据的情况下， 由于 SYN 不是 1 ， 是不消耗序列号的。 所以三次握手结束后， **客户端下一个发送的报文中** seq 依旧是 x+1， 示意图如下

![image-20230205203605996](http://www.zhangqilong.cn/img/qlBlog_images/%E6%8A%80%E6%9C%AF/%E8%AE%A1%E7%AE%97%E6%9C%BA408%E7%B3%BB%E5%88%97/%E5%9B%BE%E8%A7%A3TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B/image-20230205203605996.png)

上图第四步发送的 seq 和第三次握手的 seq 是一样的， 体现了最后一次握手， 默认不消耗序列号的特点。
