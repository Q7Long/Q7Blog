---
title: 浏览器工作原理和V8引擎
date: 2022-12-26 21:01:01
permalink: /pages/2ec345/
categories:
  - 《深入JavaScript高级》笔记
tags:
  -
author:
  name: Q7Long
  link: https://github.com/Q7Long
---

# 02 浏览器工作原理和 V8 引擎

### JavaScript 是一门高级的编程语言

- 既然有高级的编程语言 就会有低级的编程语言 从**编程语言的发展历史来说 可以划分为三个阶段**
- **但是机器本身不认识这些高级语言，所以我们的代码最终还是需要被转换成机器指令**

![img](http://www.zhangqilong.cn/img/qlBlog_images/%E6%B7%B1%E5%85%A5JavaScript%E9%AB%98%E7%BA%A7/02.%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%92%8CV8%E5%BC%95%E6%93%8E/image.png)

![img](http://www.zhangqilong.cn/img/qlBlog_images/%E6%B7%B1%E5%85%A5JavaScript%E9%AB%98%E7%BA%A7/02.%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%92%8CV8%E5%BC%95%E6%93%8E/image2.png)

### ⭐ 浏览器的工作原理

- 高级语言需要先转化成机器指令再执行，这也是 JS 引擎帮助我们做的事
- JavaScript 代码
- 浏览器是如何运行 JavaScript 代码?

- - 比如在网页上输入 baidu.com 域名会通过 DNS(专门做域名解析) 解析成 对应的 IP 地址
  - 所有的域名都会 DNS 解析成 IP 地址
  - 当我们输入 baidu.com 按下回车的时候，解析成的 IP 地址找到对应的服务器地址，服务器会返回一个 index.html 的网页，浏览器开始解析代码，解析的过程中会遇到 CSS 文件，则会去服务器里面下载对应的 CSS 文件(注意不是一次性下载完成，是遇到之后才回去下载)，遇到 Script 标签的时候，就会从服务器里下载对应的 js 文件，里面包含 JS 相关代码，比如有个 function 则会运行 function 在浏览器中运行。

![img](http://www.zhangqilong.cn/img/qlBlog_images/%E6%B7%B1%E5%85%A5JavaScript%E9%AB%98%E7%BA%A7/02.%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%92%8CV8%E5%BC%95%E6%93%8E/image3.png)

- - 比如遇到的 JS 代码下载下来之后，会被浏览器执行，那么 JS 是如何被浏览器执行的，这里就涉及到了浏览器的内核

### ⭐ 浏览器的内核(排版引擎)

- 浏览器下载的文件是很多的 有 HTML CSS JS ，谁在帮助我们解析呢，解析的过程是浏览器内核帮助我们完成的
- 不同的浏览器拥有不同的内核![img](http://www.zhangqilong.cn/img/qlBlog_images/%E6%B7%B1%E5%85%A5JavaScript%E9%AB%98%E7%BA%A7/02.%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%92%8CV8%E5%BC%95%E6%93%8E/image4.png)

### ⭐ 浏览器从下载再到渲染的过程![img](http://www.zhangqilong.cn/img/qlBlog_images/%E6%B7%B1%E5%85%A5JavaScript%E9%AB%98%E7%BA%A7/02.%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%92%8CV8%E5%BC%95%E6%93%8E/image5.png)![img](http://www.zhangqilong.cn/img/qlBlog_images/%E6%B7%B1%E5%85%A5JavaScript%E9%AB%98%E7%BA%A7/02.%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%92%8CV8%E5%BC%95%E6%93%8E/image6.png)

- HTML 是我们编写的 HTML 标签，这些标签在浏览器里面的表现形式叫做 DOM 树

### ⭐⭐⭐JavaScript 引擎

- JavaScript 代码是由 JavaScript 引擎执行的
- 为什么需要 JavaScript 引擎![img](http://www.zhangqilong.cn/img/qlBlog_images/%E6%B7%B1%E5%85%A5JavaScript%E9%AB%98%E7%BA%A7/02.%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%92%8CV8%E5%BC%95%E6%93%8E/image7.png)![img](http://www.zhangqilong.cn/img/qlBlog_images/%E6%B7%B1%E5%85%A5JavaScript%E9%AB%98%E7%BA%A7/02.%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%92%8CV8%E5%BC%95%E6%93%8E/image8.png)

### ⭐ 浏览器内核和 JS 引擎的关系![img](http://www.zhangqilong.cn/img/qlBlog_images/%E6%B7%B1%E5%85%A5JavaScript%E9%AB%98%E7%BA%A7/02.%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%92%8CV8%E5%BC%95%E6%93%8E/image9.png)

## ⭐⭐⭐V8 引擎的原理![img](http://www.zhangqilong.cn/img/qlBlog_images/%E6%B7%B1%E5%85%A5JavaScript%E9%AB%98%E7%BA%A7/02.%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%92%8CV8%E5%BC%95%E6%93%8E/image10.png)

### V8 的词法分析和语法分析

- 学过编译原理的同学可以知道，JS 文件只是一个源码，机器是无法执行的，词法分析就是把源码的字符串分割出来，生成一系列的 token，如下图可知不同的字符串对应不同的 token 类型。

![img](http://www.zhangqilong.cn/img/qlBlog_images/%E6%B7%B1%E5%85%A5JavaScript%E9%AB%98%E7%BA%A7/02.%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%92%8CV8%E5%BC%95%E6%93%8E/image11.png)

- 词法分析完后，接下来的阶段就是进行语法分析。语法分析语法分析的输入就是词法分析的输出，输出是 AST 抽象语法树。当程序出现语法错误的时候，V8 在语法分析阶段抛出异常。

![img](http://www.zhangqilong.cn/img/qlBlog_images/%E6%B7%B1%E5%85%A5JavaScript%E9%AB%98%E7%BA%A7/02.%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%92%8CV8%E5%BC%95%E6%93%8E/image12.png)

- **⭐ AST Explorer 可以查看对应代码生成的抽象语法树** https://astexplorer.net/

![img](http://www.zhangqilong.cn/img/qlBlog_images/%E6%B7%B1%E5%85%A5JavaScript%E9%AB%98%E7%BA%A7/02.%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%92%8CV8%E5%BC%95%E6%93%8E/image13.png)

- 对抽象语法树可以转化为 ES5 代码 还可以转化成字节码 第四步
- 为什么不先转换成机器码呢，为什么先转化成字节码呢？

- - 因为代码跑在什么样的环境是不确定的，所以 CPU 不一样，CPU 的架构是不一样的，架构不一样的话，第四步 Ignition 就不确定转化成哪种机器码了，所以先转化成字节码。等到代码再执行的时候，再把字节码转化成对应平台的机器码，这样比直接通过 AST 转化成机器码的效率要高，**字节码是跨平台的**

![img](http://www.zhangqilong.cn/img/qlBlog_images/%E6%B7%B1%E5%85%A5JavaScript%E9%AB%98%E7%BA%A7/02.%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%92%8CV8%E5%BC%95%E6%93%8E/image14.png)
![img](http://www.zhangqilong.cn/img/qlBlog_images/%E6%B7%B1%E5%85%A5JavaScript%E9%AB%98%E7%BA%A7/02.%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%92%8CV8%E5%BC%95%E6%93%8E/image15.png)
![img](http://www.zhangqilong.cn/img/qlBlog_images/%E6%B7%B1%E5%85%A5JavaScript%E9%AB%98%E7%BA%A7/02.%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%92%8CV8%E5%BC%95%E6%93%8E/image16.png)
![img](http://www.zhangqilong.cn/img/qlBlog_images/%E6%B7%B1%E5%85%A5JavaScript%E9%AB%98%E7%BA%A7/02.%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%92%8CV8%E5%BC%95%E6%93%8E/image17.png)
![img](http://www.zhangqilong.cn/img/qlBlog_images/%E6%B7%B1%E5%85%A5JavaScript%E9%AB%98%E7%BA%A7/02.%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%92%8CV8%E5%BC%95%E6%93%8E/image18.png)
![img](http://www.zhangqilong.cn/img/qlBlog_images/%E6%B7%B1%E5%85%A5JavaScript%E9%AB%98%E7%BA%A7/02.%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%92%8CV8%E5%BC%95%E6%93%8E/image19.png)

**预解析：\*\***由于 JS 里面函数是可以套函数的,JS 里面有很多代码，但是有很多代码不会被执行的，所以这些代码不会被解析(不会被解析成 AST 抽象语法树)，但是如果想知道比如 outer()函数里面有哪些内容的话，需要对 inner()函数进行预解析\*\*![img](http://www.zhangqilong.cn/img/qlBlog_images/%E6%B7%B1%E5%85%A5JavaScript%E9%AB%98%E7%BA%A7/02.%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%92%8CV8%E5%BC%95%E6%93%8E/image20.png)
![img](http://www.zhangqilong.cn/img/qlBlog_images/%E6%B7%B1%E5%85%A5JavaScript%E9%AB%98%E7%BA%A7/02.%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%92%8CV8%E5%BC%95%E6%93%8E/image21.png)

![img](http://www.zhangqilong.cn/img/qlBlog_images/%E6%B7%B1%E5%85%A5JavaScript%E9%AB%98%E7%BA%A7/02.%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%92%8CV8%E5%BC%95%E6%93%8E/image22.png)
![img](http://www.zhangqilong.cn/img/qlBlog_images/%E6%B7%B1%E5%85%A5JavaScript%E9%AB%98%E7%BA%A7/02.%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%92%8CV8%E5%BC%95%E6%93%8E/image23.png)

### JavaScript 的执行过程

- **_1.解析过程_**

![img](http://www.zhangqilong.cn/img/qlBlog_images/%E6%B7%B1%E5%85%A5JavaScript%E9%AB%98%E7%BA%A7/02.%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%92%8CV8%E5%BC%95%E6%93%8E/image24.png)

![img](http://www.zhangqilong.cn/img/qlBlog_images/%E6%B7%B1%E5%85%A5JavaScript%E9%AB%98%E7%BA%A7/02.%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%92%8CV8%E5%BC%95%E6%93%8E/image25.png)
![img](http://www.zhangqilong.cn/img/qlBlog_images/%E6%B7%B1%E5%85%A5JavaScript%E9%AB%98%E7%BA%A7/02.%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%92%8CV8%E5%BC%95%E6%93%8E/image26.png)

**_2.1 运行过程：V8 引擎内部会有一个执行上下文栈(ECStack)_**
![img](http://www.zhangqilong.cn/img/qlBlog_images/%E6%B7%B1%E5%85%A5JavaScript%E9%AB%98%E7%BA%A7/02.%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%92%8CV8%E5%BC%95%E6%93%8E/image27.png)
![img](http://www.zhangqilong.cn/img/qlBlog_images/%E6%B7%B1%E5%85%A5JavaScript%E9%AB%98%E7%BA%A7/02.%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%92%8CV8%E5%BC%95%E6%93%8E/image28.png)

**\*2.1 因为上面我们创建的代码是全局代码，为了全局代码能够正常的执行，需要创建 全局执行上下文\*\*\*\***(全局代码需要被执行才会创建) GEC\*\*\*![img](http://www.zhangqilong.cn/img/qlBlog_images/%E6%B7%B1%E5%85%A5JavaScript%E9%AB%98%E7%BA%A7/02.%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%92%8CV8%E5%BC%95%E6%93%8E/image29.png)

### ⭐⭐⭐ 作用域的提升原理？为什么会有作用域提升？(接上)

为什么有作用域提升，因为将刚开始定义的变量(类似于 name, num1,num2)放入了 Global Exection context(全局执行上下文)里面了，只是在解析的时候只会被赋值为 undefined，并不会找不到

- ![img](http://www.zhangqilong.cn/img/qlBlog_images/%E6%B7%B1%E5%85%A5JavaScript%E9%AB%98%E7%BA%A7/02.%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%92%8CV8%E5%BC%95%E6%93%8E/image30.png)

https://mp.weixin.qq.com/s/t__Jqzg1rbTlsCHXKMwh6A 补充了解 V8 引擎
